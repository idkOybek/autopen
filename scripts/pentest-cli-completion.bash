#!/usr/bin/env bash
# Bash completion script for pentest-cli
# Installation:
#   1. Copy this file to /etc/bash_completion.d/pentest-cli
#   2. Or source it in your ~/.bashrc:
#      source /path/to/pentest-cli-completion.bash

_pentest_cli_completions() {
    local cur prev opts base
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    # Main commands
    local commands="scan report system config --help --version --api-url"

    # Scan subcommands
    local scan_commands="start status list stop pause resume --help"

    # Report subcommands
    local report_commands="generate send --help"

    # System subcommands
    local system_commands="status metrics --help"

    # Config subcommands
    local config_commands="show set --help"

    # Determine which command we're completing
    case "${COMP_CWORD}" in
        1)
            # First level: main commands
            COMPREPLY=($(compgen -W "${commands}" -- ${cur}))
            return 0
            ;;
        2)
            # Second level: subcommands based on main command
            case "${COMP_WORDS[1]}" in
                scan)
                    COMPREPLY=($(compgen -W "${scan_commands}" -- ${cur}))
                    return 0
                    ;;
                report)
                    COMPREPLY=($(compgen -W "${report_commands}" -- ${cur}))
                    return 0
                    ;;
                system)
                    COMPREPLY=($(compgen -W "${system_commands}" -- ${cur}))
                    return 0
                    ;;
                config)
                    COMPREPLY=($(compgen -W "${config_commands}" -- ${cur}))
                    return 0
                    ;;
            esac
            ;;
        *)
            # Handle options for subcommands
            case "${prev}" in
                start)
                    # scan start options
                    COMPREPLY=($(compgen -W "--config --targets-file --targets --ftp-url --help" -- ${cur}))
                    return 0
                    ;;
                status)
                    # scan status options
                    if [[ "${COMP_WORDS[1]}" == "scan" ]]; then
                        COMPREPLY=($(compgen -W "--follow --help" -- ${cur}))
                        return 0
                    fi
                    ;;
                list)
                    # scan list options
                    COMPREPLY=($(compgen -W "--status --limit --help" -- ${cur}))
                    return 0
                    ;;
                generate)
                    # report generate options
                    COMPREPLY=($(compgen -W "--type --output --help" -- ${cur}))
                    return 0
                    ;;
                send)
                    # report send options
                    COMPREPLY=($(compgen -W "--telegram --email --ftp --help" -- ${cur}))
                    return 0
                    ;;
                --type)
                    # Report type options
                    COMPREPLY=($(compgen -W "technical executive both" -- ${cur}))
                    return 0
                    ;;
                --status)
                    # Status filter options
                    COMPREPLY=($(compgen -W "pending running completed failed paused" -- ${cur}))
                    return 0
                    ;;
                --config|--targets-file)
                    # File completion
                    COMPREPLY=($(compgen -f -- ${cur}))
                    return 0
                    ;;
                --output)
                    # Directory completion
                    COMPREPLY=($(compgen -d -- ${cur}))
                    return 0
                    ;;
            esac
            ;;
    esac
}

# Register completion function
complete -F _pentest_cli_completions pentest-cli
complete -F _pentest_cli_completions pentest
